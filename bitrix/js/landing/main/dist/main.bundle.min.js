this.BX=this.BX||{};(function(e,n,t,o,a,i){"use strict";function r(e){return!!e&&!!e.querySelector(".block-wrapper")}function s(e){return!!e&&!!e.querySelector('button[data-id="insert_first_block"]')}function l(e,n){return new Promise(function(t){var o=function o(a){if(!n||a.animationName===n){t(a);i.Event.bind(e,"animationend",o)}};i.Event.bind(e,"animationend",o)})}function c(e){if(i.Type.isNil(e)){return true}if(i.Type.isArrayLike(e)){return!e.length}if(i.Type.isObject(e)){return Object.keys(e).length<=0}return true}function d(){var e=babelHelpers.taggedTemplateLiteral(["",""]);d=function n(){return e};return e}var u="ru";var k="by";var f="kz";var h="la";var g="de";var m="br";var B="ua";BX.Landing.getMode=function(){return"edit"};var b=function(e){babelHelpers.inherits(b,e);babelHelpers.createClass(b,null,[{key:"getMode",value:function e(){return"edit"}},{key:"createInstance",value:function e(n){var t=BX.Landing.PageObject.getRootWindow();t.BX.Landing.Main.instance=new BX.Landing.Main(n)}},{key:"getInstance",value:function e(){var n=BX.Landing.PageObject.getRootWindow();n.BX.Reflection.namespace("BX.Landing.Main");if(n.BX.Landing.Main.instance){return n.BX.Landing.Main.instance}n.BX.Landing.Main.instance=new b(-1);return n.BX.Landing.Main.instance}}]);function b(e){var t;babelHelpers.classCallCheck(this,b);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(b).call(this));t.setEventNamespace("BX.Landing.Main");var o=n.Env.getInstance().getOptions();t.id=e;t.options=Object.freeze(o);t.blocksPanel=null;t.currentBlock=null;t.loadedDeps={};t.cache=new i.Cache.MemoryCache;t.onSliderFormLoaded=t.onSliderFormLoaded.bind(babelHelpers.assertThisInitialized(t));t.onBlockDelete=t.onBlockDelete.bind(babelHelpers.assertThisInitialized(t));BX.addCustomEvent("Landing.Block:onAfterDelete",t.onBlockDelete);t.adjustEmptyAreas();if(t.options.blocks){if(!t.blocksPanel){t.blocksPanel=t.createBlocksPanel();t.onBlocksListCategoryChange("last");t.blocksPanel.layout.hidden=true;i.Dom.append(t.blocksPanel.layout,document.body)}t.blocksPanel.content.hidden=false}BX.Landing.UI.Panel.StatusPanel.setLastModified(o.lastModified);BX.Landing.UI.Panel.StatusPanel.getInstance().show();return t}babelHelpers.createClass(b,[{key:"hideBlocksPanel",value:function e(){if(this.blocksPanel){return this.blocksPanel.hide()}return Promise.resolve()}},{key:"getLayoutAreas",value:function e(){return this.cache.remember("layoutAreas",function(){return[].concat(babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-header")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-sidebar")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-main")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-footer")))})}},{key:"createInsertBlockButton",value:function e(n){var o=new BX.Landing.UI.Button.Plus("insert_first_block",{text:t.Loc.getMessage("ACTION_BUTTON_CREATE")});o.on("click",this.showBlocksPanel.bind(this,null,n,o));o.on("mouseover",this.onCreateButtonMouseover.bind(this,n,o));o.on("mouseout",this.onCreateButtonMouseout.bind(this,n,o));return o}},{key:"onCreateButtonMouseover",value:function e(n,o){if(i.Dom.hasClass(n,"landing-header")||i.Dom.hasClass(n,"landing-footer")){var a=this.getLayoutAreas();if(a.length>1){var r=t.Loc.getMessage("ACTION_BUTTON_CREATE");if(i.Dom.hasClass(n,"landing-main")){o.setText("".concat(r," ").concat(t.Loc.getMessage("LANDING_ADD_BLOCK_TO_MAIN")))}if(i.Dom.hasClass(n,"landing-header")){o.setText("".concat(r," ").concat(t.Loc.getMessage("LANDING_ADD_BLOCK_TO_HEADER")))}if(i.Dom.hasClass(n,"landing-sidebar")){o.setText("".concat(r," ").concat(t.Loc.getMessage("LANDING_ADD_BLOCK_TO_SIDEBAR")))}if(i.Dom.hasClass(n,"landing-footer")){o.setText("".concat(r," ").concat(t.Loc.getMessage("LANDING_ADD_BLOCK_TO_FOOTER")))}clearTimeout(this.fadeTimeout);this.fadeTimeout=setTimeout(function(){i.Dom.addClass(n,"landing-area-highlight");a.filter(function(e){return e!==n}).forEach(function(e){i.Dom.addClass(e,"landing-area-fade")})},400)}}}},{key:"onCreateButtonMouseout",value:function e(n,o){clearTimeout(this.fadeTimeout);if(i.Dom.hasClass(n,"landing-header")||i.Dom.hasClass(n,"landing-footer")){var a=this.getLayoutAreas();if(a.length>1){o.setText(t.Loc.getMessage("ACTION_BUTTON_CREATE"));a.forEach(function(e){i.Dom.removeClass(e,"landing-area-highlight");i.Dom.removeClass(e,"landing-area-fade")})}}}},{key:"initEmptyArea",value:function e(n){if(n){n.innerHTML="";i.Dom.append(this.createInsertBlockButton(n).layout,n);i.Dom.addClass(n,"landing-empty")}}},{key:"destroyEmptyArea",value:function e(n){if(n){var t=n.querySelector('button[data-id="insert_first_block"]');if(t){i.Dom.remove(t)}i.Dom.removeClass(n,"landing-empty")}}},{key:"adjustEmptyAreas",value:function e(){this.getLayoutAreas().filter(function(e){return r(e)&&s(e)}).forEach(this.destroyEmptyArea,this);this.getLayoutAreas().filter(function(e){return!r(e)&&!s(e)}).forEach(this.initEmptyArea,this);var n=document.body.querySelector("main.landing-edit-mode");var t=!this.getLayoutAreas().some(r);if(n){if(t){i.Dom.addClass(n,"landing-empty");return}i.Dom.removeClass(n,"landing-empty")}}},{key:"enableControls",value:function e(){i.Dom.removeClass(document.body,"landing-ui-hide-controls")}},{key:"disableControls",value:function e(){i.Dom.addClass(document.body,"landing-ui-hide-controls")}},{key:"isControlsEnabled",value:function e(){return!i.Dom.hasClass(document.body,"landing-ui-hide-controls")}},{key:"appendBlock",value:function e(n,t){var o=i.Tag.render(d(),n.content);o.id="block".concat(n.id);if(!t){i.Dom.addClass(o,"landing-ui-show");l(o,"showBlock").then(function(){i.Dom.removeClass(o,"landing-ui-show")})}this.insertToBlocksFlow(o);return o}},{key:"showBlocksPanel",value:function e(n,t,o){this.currentBlock=n;this.currentArea=t;this.blocksPanel.show();if(!!t&&!!o){this.onCreateButtonMouseout(t,o)}}},{key:"createBlocksPanel",value:function e(){var n=this;var a=this.options.blocks;var i=Object.keys(a);var r=new o.Content("blocks_panel",{title:t.Loc.getMessage("LANDING_CONTENT_BLOCKS_TITLE"),className:"landing-ui-panel-block-list",scrollAnimation:true});i.forEach(function(e){var t=!c(a[e].items);var o=e==="popular";var i=a[e].separator;if(t&&!o||i){r.appendSidebarButton(n.createBlockPanelSidebarButton(e,a[e]))}});r.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton("feedback_button",{className:"landing-ui-button-sidebar-feedback",text:t.Loc.getMessage("LANDING_BLOCKS_LIST_FEEDBACK_BUTTON"),onClick:this.showFeedbackForm.bind(this)}));return r}},{key:"showSliderFeedbackForm",value:function e(){var n=this;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!this.sliderFeedbackInited){this.sliderFeedbackInited=true;this.sliderFeedback=new o.Content("slider_feedback",{title:t.Loc.getMessage("LANDING_PANEL_FEEDBACK_TITLE"),className:"landing-ui-panel-feedback"});i.Dom.append(this.sliderFeedback.layout,document.body);this.sliderFormLoader=new BX.Loader({target:this.sliderFeedback.content});this.sliderFormLoader.show();this.initFeedbackForm()}a.bitrix24=this.options.server_name;a.siteId=this.options.site_id;a.siteUrl=this.options.url;a.siteTemplate=this.options.xml_id;a.productType=this.options.productType||"Undefined";a.typeproduct=function(){if(n.options.params.type==="GROUP"){return"KNOWLEDGE_GROUP"}return n.options.params.type}();var r=this.getFeedbackFormOptions();window.b24formFeedBack({id:r.id,lang:r.lang,sec:r.sec,type:"slider_inline",node:this.sliderFeedback.content,handlers:{load:this.onSliderFormLoaded.bind(this)},presets:i.Type.isPlainObject(a)?a:{}});this.sliderFeedback.show()}},{key:"getFeedbackFormOptions",value:function e(){var n=t.Loc.getMessage("LANGUAGE_ID");var o={id:"16",sec:"3h483y",lang:"en"};switch(n){case u:case k:case f:o={id:"8",sec:"x80yjw",lang:"ru"};break;case h:o={id:"14",sec:"wu561i",lang:"la"};break;case g:o={id:"10",sec:"eraz2q",lang:"de"};break;case m:o={id:"12",sec:"r6wvge",lang:"br"};break;case B:o={id:"18",sec:"d9e09o",lang:"ua"};break;default:break}return o}},{key:"onSliderFormLoaded",value:function e(){this.sliderFormLoader.hide()}},{key:"showFeedbackForm",value:function e(){this.showSliderFeedbackForm({target:"blocksList"})}},{key:"initFeedbackForm",value:function e(){(function(e,n,t,o){e.Bitrix24FormObject=o;e[o]=e[o]||function(){arguments[0].ref=t;(e[o].forms=e[o].forms||[]).push(arguments[0])};if(e[o].forms)return;var a=n.createElement("script");var i=1*new Date;a.async=1;a.src="".concat(t,"?").concat(i);var r=n.getElementsByTagName("script")[0];r.parentNode.insertBefore(a,r)})(window,document,"https://landing.bitrix24.ru/bitrix/js/crm/form_loader.js","b24formFeedBack")}},{key:"createBlockPanelSidebarButton",value:function e(n,t){return new BX.Landing.UI.Button.SidebarButton(n,{text:t.name,child:!t.separator,className:t.new?"landing-ui-new-section":"",onClick:this.onBlocksListCategoryChange.bind(this,n)})}},{key:"onBlocksListCategoryChange",value:function e(n){var t=this;this.blocksPanel.content.hidden=false;this.blocksPanel.sidebarButtons.forEach(function(e){var t=e.id===n?"add":"remove";e.layout.classList[t]("landing-ui-active")});this.blocksPanel.content.innerHTML="";if(n==="last"){if(!this.lastBlocks){this.lastBlocks=Object.keys(this.options.blocks.last.items)}this.lastBlocks=babelHelpers.toConsumableArray(new Set(this.lastBlocks));this.lastBlocks.forEach(function(e){var n=t.getBlockFromRepository(e);t.blocksPanel.appendCard(t.createBlockCard(e,n))});return}Object.keys(this.options.blocks[n].items).forEach(function(e){var o=t.options.blocks[n].items[e];t.blocksPanel.appendCard(t.createBlockCard(e,o))});if(this.blocksPanel.content.scrollTop){requestAnimationFrame(function(){t.blocksPanel.content.scrollTop=0})}}},{key:"getBlockFromRepository",value:function e(n){var t=this.options.blocks;var o=Object.keys(t);var a=o.find(function(e){return n in t[e].items});if(a){return t[a].items[n]}}},{key:"onCopyBlock",value:function e(n){window.localStorage.landingBlockId=n.id;window.localStorage.landingBlockName=n.manifest.block.name;window.localStorage.landingBlockAction="copy";try{window.localStorage.requiredUserAction=JSON.stringify(n.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}}},{key:"onCutBlock",value:function e(n){window.localStorage.landingBlockId=n.id;window.localStorage.landingBlockName=n.manifest.block.name;window.localStorage.landingBlockAction="cut";try{window.localStorage.requiredUserAction=JSON.stringify(n.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}BX.Landing.PageObject.getBlocks().remove(n);i.Dom.remove(n.node);BX.onCustomEvent("Landing.Block:onAfterDelete",[n])}},{key:"onPasteBlock",value:function e(n){var t=this;if(window.localStorage.landingBlockId){var o="Landing::copyBlock";if(window.localStorage.landingBlockAction==="cut"){o="Landing::moveBlock"}var a={};a[o]={action:o,data:{lid:n.lid||BX.Landing.Main.getInstance().id,block:window.localStorage.landingBlockId,params:{AFTER_ID:n.id,RETURN_CONTENT:"Y"}}};BX.Landing.Backend.getInstance().batch(o,a,{action:o}).then(function(e){t.currentBlock=n;return t.addBlock(e[o].result.content)})}}},{key:"addBlock",value:function e(n,t,o){if(this.lastBlocks){this.lastBlocks.unshift(n.manifest.code)}var a=this;var r=this.appendBlock(n,o);return this.loadBlockDeps(n).then(function(e){if(!i.Type.isBoolean(t)||t===false){var o=null;var s=null;if(a.currentBlock){o=a.currentBlock.lid;s=a.currentBlock.id}if(a.currentArea){o=i.Dom.attr(a.currentArea,"data-landing");s=i.Dom.attr(a.currentArea,"data-site")}BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:e.id,selector:"#block".concat(e.id),command:"addBlock",undo:"",redo:{currentBlock:s,lid:o,code:e.manifest.code}}))}a.currentBlock=null;a.currentArea=null;var l=parseInt(n.id);var c=BX.Landing.PageObject.getBlocks().get(l);if(c){i.Dom.remove(c.node);BX.Landing.PageObject.getBlocks().remove(c)}void new BX.Landing.Block(r,{id:l,active:true,requiredUserAction:n.requiredUserAction,manifest:n.manifest,dynamicParams:n.dynamicParams});return a.runBlockScripts(n).then(function(){return r})}).catch(function(e){console.warn(e)})}},{key:"onAddBlock",value:function e(n,t,o){var a=this;var r=i.Text.toNumber(t);this.hideBlocksPanel();return this.showBlockLoader().then(this.loadBlock(n,r)).then(function(e){return new Promise(function(n){setTimeout(function(){n(e)},500)})}).then(function(e){var n=a.addBlock(e,o);a.adjustEmptyAreas();void a.hideBlockLoader();return n})}},{key:"insertToBlocksFlow",value:function e(n){var t=this.currentBlock&&this.currentBlock.node&&this.currentBlock.node.parentNode;if(t){i.Dom.insertAfter(n,this.currentBlock.node);return}i.Dom.prepend(n,this.currentArea)}},{key:"getBlockLoader",value:function e(){if(!this.blockLoader){this.blockLoader=new BX.Loader({size:60});this.blockLoaderContainer=i.Dom.create("div",{props:{className:"landing-block-loader-container"},children:[this.blockLoader.layout]})}return this.blockLoaderContainer}},{key:"showBlockLoader",value:function e(){this.insertToBlocksFlow(this.getBlockLoader());this.blockLoader.show();return Promise.resolve()}},{key:"hideBlockLoader",value:function e(){i.Dom.remove(this.getBlockLoader());this.blockLoader=null;return Promise.resolve()}},{key:"loadBlockDeps",value:function e(n){var t=this;var o=BX.processHTML(n.content_ext);if(BX.type.isArray(o.SCRIPT)){o.SCRIPT=o.SCRIPT.filter(function(e){return!e.isInternal})}var a=0;var i=n.js.length+o.SCRIPT.length+o.STYLE.length+n.css.length;var r=null;if(!this.loadedDeps[n.manifest.code]&&i>0){r=new Promise(function(e){function r(){a+=1;if(a===i){e(n)}}if(i>a){o.SCRIPT.forEach(function(e){if(!e.isInternal){BX.loadScript(e.JS,r)}});o.STYLE.forEach(function(e){BX.loadScript(e,r)});n.css.forEach(function(e){BX.loadScript(e,r)});n.js.forEach(function(e){BX.loadScript(e,r)})}else{r()}t.loadedDeps[n.manifest.code]=true})}else{r=Promise.resolve(n)}return r}},{key:"runBlockScripts",value:function e(n){return new Promise(function(e){var t=BX.processHTML(n.content).SCRIPT;if(t.length){BX.ajax.processScripts(t,undefined,function(){e(n)})}else{e(n)}})}},{key:"loadBlock",value:function e(n,t){var o=this;return function(){var e=o.id;var a=o.options.site_id;if(o.currentBlock){e=o.currentBlock.lid;a=o.currentBlock.siteId}if(o.currentArea){e=i.Dom.attr(o.currentArea,"data-landing");a=i.Dom.attr(o.currentArea,"data-site")}var r={lid:e,siteId:a};var s={ACTIVE:"Y",CODE:n,AFTER_ID:o.currentBlock?o.currentBlock.id:0,RETURN_CONTENT:"Y"};if(!t){r.fields=s;return BX.Landing.Backend.getInstance().action("Landing::addBlock",r,{code:n})}r={undeleete:{action:"Landing::markUndeletedBlock",data:{lid:e,block:t}},getContent:{action:"Block::getContent",data:{block:t,lid:e,fields:s,editMode:1}}};return BX.Landing.Backend.getInstance().batch("Landing::addBlock",r,{code:n}).then(function(e){e.getContent.result.id=t;return e.getContent.result})}}},{key:"createBlockCard",value:function e(n,t,o){return new BX.Landing.UI.Card.BlockPreviewCard({title:t.name,image:t.preview,code:n,mode:o,isNew:t.new===true,onClick:this.onAddBlock.bind(this,n)})}},{key:"onBlockDelete",value:function e(n){if(!n.parent.querySelector(".block-wrapper")){this.adjustEmptyAreas()}}},{key:"showOverlay",value:function e(){var n=document.querySelector("main.landing-edit-mode");if(n){i.Dom.addClass(n,"landing-ui-overlay")}}},{key:"hideOverlay",value:function e(){var n=document.querySelector("main.landing-edit-mode");if(n){i.Dom.removeClass(n,"landing-ui-overlay")}}},{key:"reloadSlider",value:function e(n){return a.SliderHacks.reloadSlider(n,window.parent)}}]);return b}(i.Event.EventEmitter);babelHelpers.defineProperty(b,"TYPE_PAGE","PAGE");babelHelpers.defineProperty(b,"TYPE_STORE","STORE");e.Main=b})(this.BX.Landing=this.BX.Landing||{},BX.Landing,BX.Landing,BX.Landing.UI.Panel,BX.Landing,BX);
//# sourceMappingURL=main.bundle.map.js